<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <title>Ma'lumotlarni qabul qilish</title> -->
  <title>Telegram Clone</title>
  <link rel="stylesheet" href="styles4.css">
  <style>
    
    .sidebarChatType {
        width: 3%; /* Ekranning 20 dan bir qismini egallaydi */
        min-width: 75px; /* Kichik ekranlar uchun minimal kenglik */
        background-color: #1c2b35; /* Telegram'ga o'xshash rang */
        color: #ffffff;
        display: flex;
        flex-direction: column;
        padding: 10px 0;
        box-sizing: border-box;
        height: 100vh;
        overflow: auto;
    }
    
    /* .sidebarChatType-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 4px;
        font-size: 16px;
        font-weight: bold;
        color: #ffffff;
        border-bottom: 1px solid #354f60;
    } */
    .sidebarChatType-header {
            cursor: pointer;
            background-color: #1c2b35;
            color: white;
            padding: 10px;
            text-align: center;
            border: none;
            user-select: none;
        }

        /* Dropdown menu styling */
        .dropdown-menu {
            display: none; /* Bosilmaganda menyu ko'rinmaydi */
            position: absolute;
            background-color: #f1f1f1;
            min-width: 150px;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown-menu div {
            padding: 10px;
            color: #333;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .dropdown-menu div:hover {
            background-color: #ddd;
        }
    
    .menu-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    
    .menu-list li {
        border-bottom: 1px solid #354f60;
        padding: 20px 4px;
    }
    
    
    .menu-list li:hover {
        background-color: #354f60;
        cursor: pointer;
        
    }
    
    .counter {
        background-color: #7289da;
        color: #ffffff;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 12px;
    }

    /* Modal window for input */
    .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
            text-align: center;
        }

        .modal input {
            padding: 8px;
            margin: 10px 0;
            width: 80%;
        }

        .modal button {
            padding: 8px 12px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
            background-color: #1c2b35;
            color: white;
            border-radius: 4px;
        }

        .modal p {
            color: red;
        }
    
  </style>

</head>
<body>
  <div id="container" class="container">

    <div class="sidebarChatType">
      <div class="sidebarChatType-header" onclick="toggleMenu()">
          <span>settings</span>
      </div>
      <div id="dropdownMenu" class="dropdown-menu">
        <div onclick="openGroupModal()">Create Group</div>
        <div onclick="editProfile()">Edit Profile</div>
    </div>
      <ul class="menu-list">
          <li onclick="selectChatType('all')">All <span class="counter">9</span></li>
          <li onclick="selectChatType('people')">People <span class="counter">9</span></li>
          <li onclick="selectChatType('groups')">Groups <span class="counter">9</span></li>
          <!-- <li onclick="selectChatType('all')">Channels <span class="counter">15</span></a></li> -->
      </ul>
  </div>

  <div id="groupModal" class="modal">
    <h3>Noyob nom o'ylab toping</h3>
    <input type="text" id="groupName" placeholder="Nom kiriting" oninput="checkGroupName()">
    <p id="errorMsg" style="display: none;">Bu nom band</p>
    <button id="createBtn" style="display: none;" onclick="createGroup()">Yarat</button>
  </div>

    <div id="listContainer" class="sidebar">
      <ul class="chat-list" id="owner-of-the-account"></ul>
      <div class="search-bar"><input type="text" id="groupOrAccount_Name" placeholder="Search" required /></div>
      <ul class="chat-list" id="search-chats-list"></ul>
      <ul class="chat-list" id="chats-list"></ul>
    </div>
    
    <div id="messageContainer" class="chat-window">
      <ul class="context-menu" id="contextMenu">
        <li onclick="handleAction('reply')">Reply</li>
        <li onclick="handleAction('edit')" class="edit-option">Edit</li>
        <li onclick="handleAction('copy')">Copy</li>
        <!-- <li onclick="handleAction('pin')">Pin</li> -->
        <!-- <li onclick="handleAction('forward')">Forward</li> -->
        <!-- <li onclick="handleAction('select')">Select</li> -->
        <li onclick="handleAction('delete')">Delete</li>
    </ul>
    </div>

  </div>


  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script> 
  <script>

    let handleAction;
    let selectChatType;
    const chatsList = document.getElementById("chats-list");
    const searchChatsList = document.getElementById('search-chats-list');
    searchChatsList.style.display = 'none';
    let listContainer = document.getElementById('listContainer');
    let messageContainer = document.getElementById('messageContainer');
    const contextMenu = document.getElementById("contextMenu");

    const chatIdAnd_ListAndMsDiv = new Map();    
    const userId_and_chatId = new Map();
    const userId_userData = new Map();
    const chatId_selectedFile = new Map();
    
    // const userId_MessagesIdArr = new Map();
    // const messageId_userData = new Map();
    const messageId_sender = new Map();
    
    let accountData;
    let sean;
    
    const chatId_replyToMessage = new Map();
    const chatId_editToMessage = new Map();
    let currentMessage = null;

    let divforMsTemp;
    let chatId;
    // "Create Group" funksiyasi
    let createGroup;
    let checkGroupName;
    

    function toggleMenu() {
            const menu = document.getElementById("dropdownMenu");
            if (menu.style.display === "block") {
                menu.style.display = "none"; // Yashirish
            } else {
                menu.style.display = "block"; // Ko'rsatish
            }
    }

    function openGroupModal() {
            document.getElementById("groupModal").style.display = "block";
            document.getElementById("dropdownMenu").style.display = "none";
    }


        // "Edit Profile" funksiyasi
        function editProfile() {
            alert("Edit Profile bosildi!");
        }

        window.onclick = function(event) {
            if (!event.target.closest('.sidebarChatType-header')) {
                const menu = document.getElementById("dropdownMenu");
                menu.style.display = "none";
            }
        }

    // URL parametrlarini olish
  window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      sean = JSON.parse(urlParams.get('sean'));
      console.log("sean: ", sean);
      
      const socket = io('http://localhost:3001' , {
        extraHeaders: {
          transports: ['websocket'],
          Authorization: `Bearer ${sean.token}`,
          customAccountId: sean.account_id
        }
      });

      // socket.account_id = account_id;

      console.log("socket: ", socket);

      document.addEventListener("click", () => {
        // const contextMenu = document.getElementById("contextMenu");
        contextMenu.style.display = "none";
      });

      createGroup = async function() {
        const groupName = document.getElementById("groupName").value.trim();
        document.getElementById("groupModal").style.display = "none";
        console.log("gruppa yaratishga harakat!");
        if(groupName) {
          const response = await fetch('http://localhost:3000/chats', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sean.token}`,
              },
              body: JSON.stringify({
                  type: 'group',
                  name: groupName,
                  username: groupName,
                  participant_ids: [accountData._id],
                  changeGroupData: [true],
                  removeMessage: [true]
              }),
            });

            const data = await response.json();

            console.log("create gruop data: ", data);
            
            addChatUser({chat: data, user: data, messages: [], status: '1 ta azo, 1 ta online'});
        }
      }

      checkGroupName =  async function() {
        const groupName = document.getElementById("groupName").value.trim();
        const errorMsg = document.getElementById("errorMsg");
        const createBtn = document.getElementById("createBtn");
        

        if (groupName === "" || groupName.length < 3) {
                errorMsg.style.display = "none";
                createBtn.style.display = "none";
                return;
        }

        console.log("groupName: ", groupName);
        // Agar nom band bo'lsa

          const response = await fetch('http://localhost:3000/chats/isUnique', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${sean.token}`,
              },
              body: JSON.stringify({ username: groupName })
            });

        const data = await response.json();

        if (!data.isUnique) {
                errorMsg.style.display = "block";
                createBtn.style.display = "none";
        } 
        else {
                errorMsg.style.display = "none";
                createBtn.style.display = "inline-block";
        }
        
      }

      window.onclick = function(event) {
            const modal = document.getElementById("groupModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
      }

      selectChatType = function(chatType) {
        if(chatType === 'all') {

        }
      }

      handleAction = function (action) {

        if (action === "delete" && currentMessage) {
          socket.emit("deleteMessage", {chatId, messageId: currentMessage.id});
          currentMessage = null;
        } 
        else if (action === "edit" && currentMessage) {
          // console.log("edit uchun bosildi");
          chatId_editToMessage.set(chatId, currentMessage);
          const editBox = document.getElementById("editBox" + chatId);
          const editText = document.getElementById("editText" + chatId);
          divforMsTemp.children[2].style.display = "none";
          divforMsTemp.children[3].style.display = 'flex';
          // currentMessage.querySelector('p').textContent.trim()
          const content = currentMessage.querySelector('p')?.textContent;//.trim();
          divforMsTemp.children[3].querySelector('input[type="text"]').value = content;//currentMessage.children[0].textContent;
          editText.textContent = content;
          editBox.style.display = 'block';
          divforMsTemp.children[3].querySelector('input[type="text"]').focus();
          currentMessage = null;
        } 
        else if(action === "copy" && currentMessage) {
          const messageContent = currentMessage.querySelector('p').textContent.trim();//currentMessage.children[0].textContent.trim(); // Kontentni olish
          navigator.clipboard.writeText(messageContent) // Kontentni clipboardga nusxalash
          .then(() => {
            console.log("Message copied:", messageContent);
            currentMessage = null;
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
            currentMessage = null;
          });
        } 
        else if(action === "reply" && currentMessage) {
          chatId_replyToMessage.set(chatId, currentMessage);
          const replyBox = document.getElementById("replyBox" + chatId);
          const replyText = document.getElementById("replyText" + chatId);
          // const cancelReply = document.getElementById("cancelReply");
          console.log("currentMessage for Reply: ", currentMessage);
          // const user_name = chatIdAnd_ListAndMsDiv.get(chatId)[2].name;
            const user_name = messageId_sender.get(currentMessage.id).senderName;
            replyText.textContent = `${user_name}: "${currentMessage.querySelector('p').textContent.trim()}"`;
            replyBox.style.display = "block";
            divforMsTemp.children[2].querySelector('input[type="text"]').focus();
            currentMessage = null;
            // messageInput.focus();
          // contextMenu.style.display = "none"; // ContextMenu'ni yopish
        }

        contextMenu.style.display = "none"; // Menyuni yashirish
      }

      function ownerOfAccFunc (ownerOfThisAcc) {
        accountData = ownerOfThisAcc;
        userId_userData.set(accountData._id, accountData);
        const ownerOAcc = document.getElementById('owner-of-the-account');

        ownerOAcc.innerHTML = `<li class="chat-item">
            <div class="icon deleted"></div>
            <div class="info">
              <p>${ownerOfThisAcc.name}</p>
              <span>@${ownerOfThisAcc.username}</span>
            </div>
          </li>`;
      }

      async function addChatUser({chat, user, messages, status}) {
        console.log("chat: ", chat," \n user: ", user);
        // console.log("messages: ", messages);

        userId_userData.set(user._id, user);

        if(!userId_and_chatId.has(user._id)) {
          userId_and_chatId.set(user._id, chat._id);
        }
        // chatId = chat._id;

        if(chatIdAnd_ListAndMsDiv.has(chat._id)) {
          console.log("mavjud chatni hosil qilishga urunish bo'ldi va qaytarildi ");
          return;
        }

        const chatUser_li_elem = createChatUserListElem({user, chat});
         
        const divMs = await createChatUserMessagesContainer({chat, user, messages, status});
        
        messageContainer.appendChild(divMs);

        chatsList.insertBefore(chatUser_li_elem, chatsList.children[0]);
        chatIdAnd_ListAndMsDiv.set(chat._id, [chatUser_li_elem, divMs]);
      }

      
      const searchUser = document.getElementById('groupOrAccount_Name');
      searchUser.addEventListener('input', function () {
        searchChatsList.innerHTML = "";
        if(searchUser.value.length > 2) {
          socket.emit('searchUsername', searchUser.value);
        } else {
          searchChatsList.style.display = 'none';
          chatsList.style.display = 'inline';
        }
      });

      socket.on("addChatUser", addChatUser);

      socket.on("userStatus", ({chatId, status}) => {
        chatIdAnd_ListAndMsDiv.get(chatId)[1].children[0].querySelector('span').textContent = status;
      });
      
      socket.on('searchUsername', (userOrGroups) => {
        // console.log("search userOrGroup: ", userOrGroups);
        searchChatsList.style.display = 'inline';
        chatsList.style.display = 'none';

        userOrGroups.forEach(item => {
          if(item._id === sean.account_id) {
            return;
          }
          
          if(!userId_and_chatId.has(item._id)) { 

            const div_for_li_and_button = document.createElement('div');
            div_for_li_and_button.style.display = "flex";

            const li = document.createElement('li');
            div_for_li_and_button.appendChild(li);
            li.classList.add('chat-item');

            const button_add_to_contact = document.createElement('button');
            div_for_li_and_button.appendChild(button_add_to_contact);
            button_add_to_contact.textContent = (item.type === "group") ? "Join" : "Add";
            button_add_to_contact.classList.add('add-button');
            button_add_to_contact.onclick =  async function() {
              await socket.emit("addChatUser", { type: item.type, clientAccId: sean.account_id, searchUserId: item._id});
              searchChatsList.innerHTML ='';
              searchChatsList.style.display = 'none';
              chatsList.style.display = 'inline';
            };
          
            const div1 = document.createElement('div');
            div1.classList.add('icon', 'deleted');
            const div2 = document.createElement('div');
            div2.classList.add('info');
            const p = document.createElement('p');
            p.textContent = item.name;
            const span = document.createElement('span');
            span.textContent = "@" + item.username;                           // hozircha shunday bo'lib tursin
            div2.appendChild(p);
            div2.appendChild(span);
            li.appendChild(div1);
            li.appendChild(div2);
            
            searchChatsList.appendChild(div_for_li_and_button);
          } else {

            const div_for_li_and_button = document.createElement('div');
            div_for_li_and_button.style.display = "flex";

            const li = document.createElement('li');
            div_for_li_and_button.appendChild(li);
            li.classList.add('chat-item');
            const button_open_contact = document.createElement('button');
            div_for_li_and_button.appendChild(button_open_contact);
            button_open_contact.textContent = "Open";
            button_open_contact.classList.add('add-button');
          
            const div1 = document.createElement('div');
            div1.classList.add('icon', 'deleted');
            const div2 = document.createElement('div');
            div2.classList.add('info');
            const p = document.createElement('p');
            p.textContent = item.name;
            const span = document.createElement('span');
            span.textContent = "@" + item.username;                           // hozircha shunday bo'lib tursin
            div2.appendChild(p);
            div2.appendChild(span);
            li.appendChild(div1);
            li.appendChild(div2);
            button_open_contact.onclick =  function() {
              // await socket.emit("addChatUser", {clientAccId: account_id, searchUserId: item._id});
              chatId = userId_and_chatId.get(item._id);
              if(divforMsTemp) {
                divforMsTemp.style.display = 'none';
              }
              divforMsTemp = chatIdAnd_ListAndMsDiv.get(chatId)[1];
              divforMsTemp.style.display = 'block';

              searchChatsList.innerHTML ='';
              searchChatsList.style.display = 'none';
              chatsList.style.display = 'inline';
            };
            searchChatsList.appendChild(div_for_li_and_button);
          }
          
        });
      });

      socket.on('takeAllData', async ({chats, ownerUser}) => {
        ownerOfAccFunc(ownerUser);
        // console.log("chats: ", chats);
        // {chat, user, messages, status}
        chats.sort((itm1, itm2) => {
          let itm1_time = itm1.messages.length > 0 ? itm1.messages.at(-1).timestamp : itm1.chat.timestamp;
          let itm2_time = itm2.messages.length > 0 ? itm2.messages.at(-1).timestamp : itm2.chat.timestamp;
          // let itm1_time = itm1.messages.length > 0 ? itm1.messages[itm1.messages.length-1].timestamp : itm1.chat.timestamp;
          // let itm2_time = itm2.messages.length > 0 ? itm2.messages[itm2.messages.length-1].timestamp : itm2.chat.timestamp;
          return new Date(itm1_time).getTime() - new Date(itm2_time).getTime();
        });
        // console.log("chats: ", chats);
        chats.forEach(await addChatUser);
      });

      socket.on('message', async function({ message, replying_for_Ms}) {
        const liListAndMsDiv = chatIdAnd_ListAndMsDiv.get(message.chat_id);
        const liList = liListAndMsDiv[0];
        chatsList.removeChild(liList);
        chatsList.insertBefore(liList, chatsList.children[0]);
        
        const messagesDiv = liListAndMsDiv[1].children[1];
        const messageDiv = await appendMessage({ message, replying_for_Ms});
        messagesDiv.appendChild(messageDiv);
      });

      socket.on('deleteMessage', function(data) {     // {chatId, messageId}
        document.getElementById(data.messageId).remove();
      });
      
      socket.on('replyMessageDelete', function(data) {     // {chatId, messageId}
        const messageDiv = document.getElementById(data.messageId);
        console.log("div: ", messageDiv);
        if(messageDiv) {
          // const replyingForMs = messageDiv.querySelector('.reply-content');
          const replyingForMs = messageDiv.children[0];
          console.log("replyingForMs: ", replyingForMs);
          replyingForMs?.remove();
        }
        // messageDiv.innerHTML = `<p>${message.content}</p>
        //   <span>${getDateLikeHHMM(message.timestamp)}</span>`;
      })
      
      socket.on('replyMessageEdit', function(data) {     // {chatId, messageId}
        const messageDiv = document.getElementById(data.messageId);
        // const sender = messageId_sender.get(data.messageId);
        // const sender = userId_userData(sender.sender_id);
        const replyText = messageDiv.querySelector('small');
        const [sender] =  replyText.textContent.split(": ");
        replyText.textContent = sender + ": \"" + data.content + "\"";
        
        // messageDiv.innerHTML = `<p>${message.content}</p>
        //   <span>${getDateLikeHHMM(message.timestamp)}</span>`;
      })

      socket.on('editMessage', function(data) {
        document.getElementById(data.messageId).querySelector('p').textContent = data.content;
      });

      socket.on('receiveFile', function(data) {
        console.log('file data: ', data);
        alert(data);
      })

      async function appendMessage ({ message, replying_for_Ms}) {
        const messageDiv = document.createElement('div');
        messageId_sender.set(message._id, {sender_id: message.sender_id, senderName: message.senderName});
        messageDiv.id = message._id;

        messageDiv.addEventListener("contextmenu", (event) => {
          event.preventDefault();
          const closestMessage = event.target.closest(".message");
            if (closestMessage) {
              currentMessage = closestMessage;
              const isIncoming = closestMessage.classList.contains("incoming");
              const editOption = contextMenu.querySelector(".edit-option");
              if (isIncoming) {
                editOption.style.display = "none";
              } 
              else {
                editOption.style.display = "block";
              }
              contextMenu.style.top = `${event.clientY}px`;
              contextMenu.style.left = `${event.clientX}px`;
              contextMenu.style.display = "block";
            }
        });

        if(replying_for_Ms) {
          // const user = userId_userData.get(replying_for_Ms.sender_id)?.name;
          const user = replying_for_Ms.senderName;
          const replying_for_Ms_content = document.createElement('div');
          replying_for_Ms_content.innerHTML = `<small>${user}: "${replying_for_Ms.content}"</small>`;
          replying_for_Ms_content.classList.add('reply-context');

          messageDiv.appendChild(replying_for_Ms_content);
        } 

        

        const messageContent = document.createElement('div');

        if(userId_and_chatId.has(message.chat_id)) {
          const span = document.createElement('span');
          span.textContent = message.senderName;
          messageContent.appendChild(span);
        }

        if(message.fileUrl) {
          const messageFile = await createMessageFile(message.fileUrl);
          messageContent.appendChild(messageFile);
          // messageDiv.append(messageFile);
        }


        // if(userId_and_chatId.has(message.chat_id)) {
        //   messageContent.innerHTML = `<span>${message.sen}</span>`
        // }
        const messageContentText = document.createElement('p');
        messageContentText.textContent = message.content ?? '';
        messageContent.appendChild(messageContentText);

        const messageTimeStamp = document.createElement('span');
        messageTimeStamp.textContent = getDateLikeHHMM(message.timestamp);
        messageContent.appendChild(messageTimeStamp);

          // messageContent.innerHTML = `<p>${message.content ?? ''}</p>
          // <span>${getDateLikeHHMM(message.timestamp)}</span>`;
        

          messageDiv.appendChild(messageContent);
        // }
        // messageDiv.innerHTML = `<p>${messageObj.message.content}</p><span>${getDateLikeHHMM(messageObj.message.timestamp)}</span>`;
        if(sean.account_id == message.sender_id) {
          // liList.children[1].children[1].textContent = '[' + messageObj.message.content + "\n[You: "+ getDateLikeHHMM(messageObj.message.timestamp) + ']]';
          messageDiv.classList.add('message', 'outgoing');
        } else {
          // liList.children[1].children[1].textContent = '[' + messageObj.message.content + " \n[ "+ getDateLikeHHMM(messageObj.message.timestamp)+ ']]';
          messageDiv.classList.add('message', 'incoming');
        }
        return messageDiv;
      }

      async function createMessageFile(fileUrl) {
            // console.log('file:', file);
            // const link = document.createElement('a');
            // link.href = file.path;
            // link.target = '_blank';
            // link.innerText = file.filename;
            // const path = "file:///D:/nodejs/nest.js/my-nest-project/"
            const response = await fetch(fileUrl, {
              method: "GET",
              headers: {
                'Authorization': `Bearer ${sean.token}`,
              },
            });
            console.log("file response: ", response); 
            const blob = await response.blob();
            const mimetype = await response.headers.get('Content-Type');
            const url = URL.createObjectURL(blob);

            if(mimetype.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = url;
              // img.alt = file.filename;
              img.style.maxWidth = '200px';
              img.style.cursor = 'pointer';
  
              // link.appendChild(img);
              img.onclick = () => window.open(url, '_blank');
              return img;
            }
            else if(mimetype.startsWith('video/')) {
              const video = document.createElement('video');
              video.src = url;
              video.controls = true;
              video.style.maxWidth = '200px';
  
              // link.appendChild(video);
              // video.onclick = () => window.open(file.path, '_blank');
              return video;
            }
            else if (mimetype.startsWith('audio/')) {
              const audio = document.createElement('audio');
              audio.controls = true;
  
              // link.appendChild(audio);
              // audio.onclick = () => window.open(file.path, '_blank');
              return audio;
            } 
            // else if (file.mimetype === 'application/pdf') {
            //   link.innerText = `PDF: ${file.filename}`;
            // } 
            else {
              const link = document.createElement('a');
              // const fileName = fileUrl.split('\/').at(-1).slice(14);
              const fileName = fileUrl.slice(44);
              link.href = url;
              link.target = '_blank';
              link.download = fileName;
              link.innerText = `${fileName}`;
              return link;
            }
        // messageDiv.appendChild(link);
      }
          
    

      function createChatUserListElem({user, chat}) {
        const li = document.createElement('li');
        li.classList.add('chat-item');
        const div1 = document.createElement('div');
        div1.classList.add('icon', 'deleted');

        const div2 = document.createElement('div');
        div2.classList.add('info');
        const p = document.createElement('p');
        p.textContent = user.name;
        const span = document.createElement('span');
        
        span.textContent = "@" + user.username;
        // if(messages && messages.length > 0){
        //   const lastMessage = messages[messages.length-1];
        //   if(lastMessage.sender_id === account_id) {
        //     span.textContent = '[' + lastMessage.content + "\n[You: "+ getDateLikeHHMM(lastMessage.timestamp) + ']]';
        //   } else {
        //     span.textContent = '[' + lastMessage.content + "\n[ "+ getDateLikeHHMM(lastMessage.timestamp) + ']]';
        //   }
        // }
        div2.appendChild(p);
        div2.appendChild(span);
        li.appendChild(div1);
        li.appendChild(div2);
        li.onclick = function() {
          chatId = chat._id;
          if(divforMsTemp) {
            divforMsTemp.style.display = 'none';
          }
          divforMsTemp = chatIdAnd_ListAndMsDiv.get(chatId)[1];
          divforMsTemp.style.display = 'block';
          divforMsTemp.children[2].querySelector('input[type="text"]').focus();
        };
        return li;
      }

    async function createChatUserMessagesContainer ({chat, user, messages, status}) {
      const divMs = document.createElement('div');
        // divMs.classList.add('chat-window');
      const divHeader = createChatUserHeader({user, status});
      divMs.appendChild(divHeader);
      
      const divChatBody = await createChatUserChatBody({messages, user});
      divMs.appendChild(divChatBody);

      const div_for_replyBox_inputBox = document.createElement('div');
      div_for_replyBox_inputBox.classList.add('reply-and-input-box');
      divMs.appendChild(div_for_replyBox_inputBox);

      const replyBox = createChatUserReplyBox({chat});
      div_for_replyBox_inputBox.appendChild(replyBox);

      const selectFileBox = createChatUserSelectFile(chat);
        
      const divInput = createChatUserInputMs(replyBox, chat, selectFileBox);
      div_for_replyBox_inputBox.appendChild(divInput);

      const div_for_editBox = document.createElement('div');
      div_for_editBox.style.display = "none";
      div_for_editBox.classList.add('reply-and-input-box');
      divMs.appendChild(div_for_editBox);
      const {editBox, editText} = createChatUserEditBox({chat});
      div_for_editBox.appendChild(editBox);


      const divEdit = createChatUserEditMs(div_for_replyBox_inputBox, div_for_editBox, editBox, editText);
      // divEdit.insertBefore(editBox, divEdit.children[0])
      div_for_editBox.appendChild(divEdit);

      divMs.style.display = 'none';
      
      return divMs;
    }
    
    function createChatUserHeader ({user, status}) {
      const divHeader = document.createElement('div');
        divHeader.classList.add('chat-header');
        const p2 = document.createElement('p');
        divHeader.appendChild(p2);
        p2.textContent = user.name;
        const span2 = document.createElement('span');
        divHeader.appendChild(span2);
        span2.textContent = status//? "online": "offline";
      return divHeader;
    }
    
    async function createChatUserChatBody({messages}) {
      const divChatBody = document.createElement('div');
        divChatBody.classList.add('chat-body');
        if(messages && messages.length && messages.length > 0)
        for(let i = 0; i < messages.length; i++) {
          const messageDiv = await appendMessage(messages[i]);
          // console.log("takeAllData message file: ", messages[i]?.file);
          divChatBody.appendChild(messageDiv);  
        }
      return divChatBody;
    }

    function createChatUserReplyBox({chat}) {
      const replyBox = document.createElement('div');
      replyBox.classList.add('reply-box');
      replyBox.id = 'replyBox' + chat._id;
      replyBox.style.display = 'none';
        // replyBox.innerHTML = `<span id="replyText"></span><button id="cancelReply">Cancel</button>`;

        const replyText = document.createElement('span');
        replyBox.appendChild(replyText);
        replyText.id = 'replyText' + chat._id;

        const concelReply = document.createElement('button');
        replyBox.appendChild(concelReply);
        // concelReply.id = 'concelReply' + chat._id;
        concelReply.textContent = "Concel";
        concelReply.addEventListener('click', function () {
          replyBox.style.display = "none";
          replyText.textContent = "";
          chatId_replyToMessage.set(chatId, null);

        });
      return replyBox;
    }

    function createChatUserSelectFile() {
      const selectFileBox = document.createElement('div');
      return selectFileBox;
    }

    function createChatUserInputMs(divReplyBox, chat, selectFileBox) {
      const divInput = document.createElement('div');
        divInput.appendChild(selectFileBox);
        const {fileInput, fileLabel} = createChatUserFileInput(chat, selectFileBox); 
        divInput.appendChild(fileInput);
        divInput.appendChild(fileLabel);

        const input = document.createElement('input');
        divInput.appendChild(input);
        const button = document.createElement('button');
        divInput.appendChild(button);
        divInput.classList.add('chat-input');
        input.type = 'text';
        input.placeholder = 'Type a message...';
        button.textContent = "Send";
        input.addEventListener('keypress', async function(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            // event.preventDefault(); // Enter tugmasi bilan formani yuborishning oldini olish
            sendMessage({input, divReplyBox, selectFileBox});
          }
        });
        button.addEventListener('click', function () {
          sendMessage({input, divReplyBox, selectFileBox});
          // if (input.value.trim() !== '') {
          //   socket.emit('message', {
          //       content: input.value,
          //       chatId,
          //       sender_id: sean.account_id,
          //       replying_for_Ms_Id: chatId_replyToMessage.get(chatId)?.id
          //     });
          //     input.value = '';
          //     divReplyBox.style.display = "none";
          //     spanReply.textContent = "";
          //     chatId_replyToMessage.set(chatId, null);
          // }
        });
      return divInput; 
    }
    
    async function sendMessage({input, divReplyBox, selectFileBox}) {
      const selectFile = chatId_selectedFile.get(chatId);
      if (input.value.trim() !== '' || selectFile) {
        let fileData = null;
        if(selectFile) {
          fileData = await uploadFile(selectFile);
          console.log("fileData: ", fileData);
        }
              // console.log("fileData: ", fileData);
        socket.emit('message', {
          content: input.value,
          fileUrl: fileData?.url,
          chatId,
          sender_id: sean.account_id,
          senderName: accountData.name,
          replying_for_Ms_Id: chatId_replyToMessage.get(chatId)?.id
        });
        input.value = ''; 
        selectFileBox.innerHTML = '';
        chatId_selectedFile.set(chatId, null);
        divReplyBox.style.display = "none";
        divReplyBox.querySelector('span').textContent = '';
        chatId_replyToMessage.set(chatId, null);
      }
    }

    function createChatUserFileInput(chat, selectFileBox) {
      const fileInput = document.createElement('input')
      fileInput.type = 'file';
      fileInput.id = "file-input" + chat._id;
      fileInput.classList.add('file-input');
      fileInput.style.display = 'none';
      fileInput.onchange = async function(event) {
        const file = event.target.files[0];
        console.log("selected file: ", file)
        if (file) {
          chatId_selectedFile.set(chat._id, [file]);

          let selectFile;
          const fileType = file.type;
          if (fileType.startsWith('image/')) {
            // Rasm uchun
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '30px';
            img.style.maxHeight = '30px';
            // preview.appendChild(img);
            selectFile = img;
          }
          else if (fileType === 'application/pdf') {
            // PDF uchun
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            

            const fileURL = URL.createObjectURL(file);
            const pdfDoc = await pdfjsLib.getDocument(fileURL).promise; // PDF ochiladi
            const page = await pdfDoc.getPage(1); // 1-chi sahifa
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
      
            const viewport = page.getViewport({ scale: 0.03 }); // Scale - kattalashtirish
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;
            // const pdfDoc = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
            // const page = await pdfDoc.getPage(1);
            // const canvas = document.createElement('canvas');
            // const context = canvas.getContext('2d');

            // const viewport = page.getViewport({ scale: 1 });
            // canvas.height = viewport.height;
            // canvas.width = viewport.width;
            // page.render({ canvasContext: context, viewport: viewport });
            // preview.appendChild(canvas);
            selectFile = canvas;
          } 
          else if (fileType.startsWith('video/')) {
            // Video uchun
            const videoIcon = document.createElement('div');
            const names = file.name.split('.');
            videoIcon.textContent = 'ðŸŽ¥ ' + names[0].slice(0, 4) + "... ." + names.at(-1);
            // videoIcon.textContent = 'ðŸŽ¥ Video File';
            videoIcon.style.fontSize = '10px';
            videoIcon.style.color = '#333';
            // preview.appendChild(videoIcon);
            selectFile = videoIcon;
          } 
          else {
            const otherFile = document.createElement('p');
            const names = file.name.split('.');
            otherFile.textContent = names[0].slice(0, 4) + "... ." + names.at(-1);
            otherFile.style.fontSize = "10px"; // Masalan, 16 piksel
            // otherFile.style.fontWeight = "bold";
            selectFile = otherFile;
          }
          selectFileBox.innerHTML = '';

          selectFileBox.appendChild(selectFile);

          cancelSelectFile = document.createElement('button');
          selectFileBox.appendChild(cancelSelectFile);
          cancelSelectFile.textContent = "cancel";

          // Buton matn o'lchamini kichikroq qilish
          cancelSelectFile.classList.add('file-cancel-button');

          cancelSelectFile.addEventListener('click', function() {
            selectFile.remove();
            cancelSelectFile.remove();
            chatId_selectedFile.set(chat._id, null);
          });
        }
      };
      const fileLabel = document.createElement('label');
      fileLabel.setAttribute("for", "file-input" + chat._id);
      fileLabel.textContent = "ðŸ“Ž";
      fileLabel.classList.add('upload-button');
      return {fileInput, fileLabel};
    }

  async function uploadFile(files) {
    const formData = new FormData();
          formData.append('file', files[0]);

          const response = await fetch('http://localhost:3000/files/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${sean.token}`,
            },
            body: formData,
          });

          const fileData = await response.json();
    return fileData;
  }
    
    function createChatUserEditBox({chat}) {
      const editBox = document.createElement('div');
      editBox.classList.add('reply-box');
      editBox.id = 'editBox' + chat._id;
      // editBox.style.display = 'none';
        // replyBox.innerHTML = `<span id="replyText"></span><button id="cancelReply">Cancel</button>`;
        const editText = document.createElement('span');
        editBox.appendChild(editText);
        editText.id = 'editText' + chat._id;
        const concelReply = document.createElement('button');
        editBox.appendChild(concelReply);
        concelReply.id = 'concelEdit' + chat._id;
        concelReply.textContent = "Concel";
        concelReply.addEventListener('click', function () {
          editBox.style.display = "none";
          editText.textContent = "";
          chatId_editToMessage.set(chatId, null);
          divforMsTemp.children[3].style.display = "none";
          divforMsTemp.children[2].style.display = 'flex';

        });
      return {editBox, editText};
    }

    function createChatUserEditMs(div_for_replyBox_inputBox, div_for_editBox, editBox, editText) {
      const divInput2 = document.createElement('div');
        const input2 = document.createElement('input');
        divInput2.appendChild(input2);
        const button2 = document.createElement('button');
        divInput2.appendChild(button2);
        div_for_editBox.style.display = 'none';
        divInput2.classList.add('chat-input');
        input2.type = 'text';
        button2.textContent = "Edit";
        input2.addEventListener('keypress', function(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            // event.preventDefault(); // Enter tugmasi bilan formani yuborishning oldini olish
            if (input2.value.trim() !== '') {
              socket.emit('editMessage', {
                messageId: chatId_editToMessage.get(chatId).id,
                chatId,
                content: divforMsTemp.children[3].querySelector('input').value,
              });
              input2.value = '';
              // editBox.style.display = "none";
              editText.textContent = "";
              chatId_editToMessage.set(chatId, null);
              div_for_replyBox_inputBox.style.display = 'flex';
              div_for_editBox.style.display = 'none';
            }
          }
        });
        button2.addEventListener('click', function () {
          if (input2.value.trim() !== '') {
            socket.emit('editMessage', {
                messageId: chatId_editToMessage.get(chatId).id,
                chatId,
                content: divforMsTemp.children[3].querySelector('input').value,
              });
              input2.value = '';
              editBox.style.display = "none";
              editText.textContent = "";
              chatId_editToMessage.set(chatId, null);
              div_for_replyBox_inputBox.style.display = 'flex';
              div_for_editBox.style.display = 'none';
          }
        });
      return divInput2;
    }
  }

    
    function getDateLikeHHMM(time) {
      if (time) {
        time = new Date(time);
      } 
      else {
        time = new Date();
      }
      let hours = time.getHours();   
      let minutes = time.getMinutes(); 
      hours = hours < 10 ? '0' + hours : hours;
      minutes = minutes < 10 ? '0' + minutes : minutes;
        return `${hours}:${minutes}`;
    }

  </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>


</body>
</html>

